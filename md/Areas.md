# üß≠ Documentaci√≥n del M√≥dulo: √Åreas

Este documento define los endpoints y reglas del m√≥dulo **√Åreas** de ERP Ganado. Cubre lectura con filtros, creaci√≥n, actualizaci√≥n, cambio de estado y borrado l√≥gico. Se basa en `AreaModel`, `AreaController` y las rutas provistas (solo **GET/POST/DELETE**).

---

## 1) Listar √Åreas

**Funci√≥n (Controller):** `listar()`  
**Endpoint:** `GET /areas`  
**Descripci√≥n:** Devuelve una lista paginada de √°reas. Por defecto excluye eliminadas l√≥gicamente (`a.deleted_at IS NULL`). Permite filtrar por `aprisco_id` y por `tipo_area`.

### Par√°metros (Query)
- `limit` *(int, opcional, por defecto 100)*  
- `offset` *(int, opcional, por defecto 0)*  
- `incluirEliminados` *(int, opcional: 0|1, por defecto 0)*  
- `aprisco_id` *(string UUID, opcional)* ‚Äî Filtro por aprisco.  
- `tipo_area` *(string, opcional)* ‚Äî Uno de: `LEVANTE_CEBA`, `GESTACION`, `MATERNIDAD`, `REPRODUCCION`, `CHIQUERO`.

### Respuestas
**√âxito (200 OK)**
```json
{
  "value": true,
  "message": "Listado de √°reas obtenido correctamente.",
  "data": [
    {
      "area_id": "5a1f9c5d-5141-47e1-87e2-3c1304a7932a",
      "aprisco_id": "b7c7b9a8-1b83-4e1f-8a71-0c2f7a8620bf",
      "nombre_aprisco": "Aprisco Norte",
      "nombre_personalizado": "Corral 1",
      "tipo_area": "LEVANTE_CEBA",
      "numeracion": "LC-01",
      "estado": "ACTIVA",
      "created_at": "2025-10-02 11:25:00",
      "created_by": "b7c7b9a8-1b83-4e1f-8a71-0c2f7a8620bf",
      "updated_at": null,
      "updated_by": null
    }
  ]
}
```

**Error (400 Bad Request)** cuando `tipo_area` no es v√°lido.  
**Error (500 Internal Server Error)** para fallos inesperados.

### Ejemplo (cURL)
```bash
# Lista general
curl -X GET 'https://tu-dominio/areas?limit=20&offset=0'

# Filtrar por aprisco
curl -X GET 'https://tu-dominio/areas?aprisco_id=b7c7b9a8-1b83-4e1f-8a71-0c2f7a8620bf'

# Filtrar por tipo de √°rea
curl -X GET 'https://tu-dominio/areas?tipo_area=GESTACION'
```

---

## 2) Obtener √Årea por ID

**Funci√≥n:** `mostrar($params)`  
**Endpoint:** `GET /areas/{area_id}`  
**Descripci√≥n:** Devuelve los detalles del √°rea, incluyendo `nombre_aprisco` (JOIN).

### Par√°metros (URL)
- `area_id` *(string UUID, requerido)*

### Respuestas
**√âxito (200 OK)**
```json
{
  "value": true,
  "message": "√Årea encontrada.",
  "data": {
    "area_id": "5a1f9c5d-5141-47e1-87e2-3c1304a7932a",
    "aprisco_id": "b7c7b9a8-1b83-4e1f-8a71-0c2f7a8620bf",
    "nombre_aprisco": "Aprisco Norte",
    "nombre_personalizado": "Corral 1",
    "tipo_area": "LEVANTE_CEBA",
    "numeracion": "LC-01",
    "estado": "ACTIVA",
    "created_at": "2025-10-02 11:25:00",
    "created_by": "b7c7b9a8-1b83-4e1f-8a71-0c2f7a8620bf",
    "updated_at": null,
    "updated_by": null,
    "deleted_at": null,
    "deleted_by": null
  }
}
```

**No encontrado (404 Not Found)**  
```json
{ "value": false, "message": "√Årea no encontrada.", "data": null }
```

**Error de par√°metro (400 Bad Request)**  
```json
{ "value": false, "message": "Par√°metro area_id es obligatorio.", "data": null }
```

### Ejemplo (cURL)
```bash
curl -X GET 'https://tu-dominio/areas/5a1f9c5d-5141-47e1-87e2-3c1304a7932a'
```

---

## 3) Crear √Årea

**Funci√≥n:** `crear()`  
**Endpoint:** `POST /areas`  
**Descripci√≥n:** Crea un √°rea en un **aprisco** existente. Aplica zona horaria y contexto de auditor√≠a.

### Cuerpo (JSON)
- `aprisco_id` *(string UUID, **requerido**)* ‚Äî Debe existir y no estar eliminado.  
- `tipo_area` *(string, **requerido**)* ‚Äî Uno de: `LEVANTE_CEBA`, `GESTACION`, `MATERNIDAD`, `REPRODUCCION`, `CHIQUERO`.  
- `nombre_personalizado` *(string, opcional)*  
- `numeracion` *(string, opcional)*  
- `estado` *(string, opcional, por defecto `'ACTIVA'`)* ‚Äî Valores permitidos: `'ACTIVA' | 'INACTIVA'`.

### Validaciones y reglas
- Verificaci√≥n previa: `apriscoExiste(aprisco_id)`; si falla ‚Üí **409**.  
- Validaci√≥n de cat√°logo: `validarTipoArea(tipo_area)`; si falla ‚Üí **400**.  
- Se recomienda **√≠ndice √∫nico** sobre combinaci√≥n (`aprisco_id`, `tipo_area`, `numeracion`) o (`aprisco_id`, `tipo_area`, `nombre_personalizado`) seg√∫n tu negocio, para evitar duplicados.

### Respuestas
**√âxito (200 OK)**
```json
{
  "value": true,
  "message": "√Årea creada correctamente.",
  "data": { "area_id": "uuid-generado" }
}
```

**Errores comunes**
```json
{ "value": false, "message": "Faltan campos requeridos: aprisco_id, tipo_area.", "data": null }
```
```json
{ "value": false, "message": "El aprisco especificado no existe o est√° eliminado.", "data": null }
```
```json
{ "value": false, "message": "tipo_area inv√°lido. Use uno de: LEVANTE_CEBA, GESTACION, MATERNIDAD, REPRODUCCION, CHIQUERO", "data": null }
```
```json
{ "value": false, "message": "Ya existe un √°rea con esa combinaci√≥n (ver √≠ndice √∫nico).", "data": null }
```

**Error (500 Internal Server Error)**

### Ejemplo (cURL)
```bash
curl -X POST 'https://tu-dominio/areas'   -H 'Content-Type: application/json'   -d '{
    "aprisco_id": "b7c7b9a8-1b83-4e1f-8a71-0c2f7a8620bf",
    "tipo_area": "GESTACION",
    "nombre_personalizado": "Gestaci√≥n A",
    "numeracion": "G-01",
    "estado": "ACTIVA"
  }'
```

---

## 4) Actualizar √Årea (campos expl√≠citos)

**Funci√≥n:** `actualizar($params)`  
**Endpoint:** `POST /areas/{area_id}`  
**Descripci√≥n:** Actualiza `aprisco_id`, `tipo_area`, `nombre_personalizado`, `numeracion` y/o `estado`. Solo modifica los campos enviados.

### Par√°metros (URL)
- `area_id` *(string UUID, requerido)*

### Cuerpo (JSON ‚Äî todos opcionales)
- `aprisco_id` *(string UUID)* ‚Äî Si se env√≠a, debe existir y no estar eliminado.  
- `tipo_area` *(string)* ‚Äî Validado contra el cat√°logo.  
- `nombre_personalizado` *(string | null)*  
- `numeracion` *(string | null)*  
- `estado` *(string: `'ACTIVA' | 'INACTIVA'`)*

### Validaciones y reglas
- Al menos **un** campo debe enviarse.  
- Si cambia `aprisco_id`, se valida existencia (FK).  
- Validaci√≥n de `tipo_area`.  
- Unicidad recomendada por combinaci√≥n (ver secci√≥n de modelo).

### Respuestas
**√âxito (200 OK)**
```json
{
  "value": true,
  "message": "√Årea actualizada correctamente.",
  "data": { "updated": true }
}
```

**Errores comunes (400/409)**
```json
{ "value": false, "message": "No hay campos para actualizar.", "data": null }
```
```json
{ "value": false, "message": "aprisco_id no v√°lido (no existe o est√° eliminado).", "data": null }
```
```json
{ "value": false, "message": "tipo_area inv√°lido. Use uno de: LEVANTE_CEBA, GESTACION, MATERNIDAD, REPRODUCCION, CHIQUERO", "data": null }
```
```json
{ "value": false, "message": "Conflicto de unicidad (ver √≠ndice √∫nico).", "data": null }
```

**Error (500 Internal Server Error)**

### Ejemplo (cURL)
```bash
curl -X POST 'https://tu-dominio/areas/5a1f9c5d-5141-47e1-87e2-3c1304a7932a'   -H 'Content-Type: application/json'   -d '{ "nombre_personalizado": "Corral 2", "estado": "INACTIVA" }'
```

---

## 5) Actualizar **solo** el Estado

**Funci√≥n:** `actualizarEstado($params)`  
**Endpoint:** `POST /areas/{area_id}/estado`  
**Descripci√≥n:** Cambia √∫nicamente el `estado` del √°rea.

### Par√°metros (URL)
- `area_id` *(string UUID, requerido)*

### Cuerpo (JSON)
- `estado` *(string, **requerido**: `'ACTIVA' | 'INACTIVA'`)*

### Respuestas
**√âxito (200 OK)**
```json
{
  "value": true,
  "message": "Estado del √°rea actualizado correctamente.",
  "data": { "updated": true }
}
```

**Errores (400)**
```json
{ "value": false, "message": "El campo estado es obligatorio.", "data": null }
```
```json
{ "value": false, "message": "Valor de estado inv√°lido. Use 'ACTIVA' o 'INACTIVA'.", "data": null }
```

**Error (500 Internal Server Error)**

### Ejemplo (cURL)
```bash
curl -X POST 'https://tu-dominio/areas/5a1f9c5d-5141-47e1-87e2-3c1304a7932a/estado'   -H 'Content-Type: application/json'   -d '{ "estado": "ACTIVA" }'
```

---

## 6) Eliminar √Årea (borrado l√≥gico)

**Funci√≥n:** `eliminar($params)`  
**Endpoint:** `DELETE /areas/{area_id}`  
**Descripci√≥n:** Marca `deleted_at` y `deleted_by`. No elimina f√≠sicamente.

### Par√°metros (URL)
- `area_id` *(string UUID, requerido)*

### Respuestas
**√âxito (200 OK)**
```json
{
  "value": true,
  "message": "√Årea eliminada correctamente.",
  "data": { "deleted": true }
}
```

**No se pudo eliminar (400 Bad Request)**
```json
{ "value": false, "message": "No se pudo eliminar (o ya estaba eliminada).", "data": null }
```

**Error (500 Internal Server Error)**

### Ejemplo (cURL)
```bash
curl -X DELETE 'https://tu-dominio/areas/5a1f9c5d-5141-47e1-87e2-3c1304a7932a'
```

---

## Modelo de Datos (Tabla `areas`)

| Campo                 | Tipo                        | Notas                                                                                 |
|-----------------------|-----------------------------|---------------------------------------------------------------------------------------|
| `area_id`             | `CHAR(36)` (UUID)           | **PK**                                                                                |
| `aprisco_id`          | `CHAR(36)` (UUID)           | **FK** ‚Üí `apriscos.aprisco_id` (requerida, no eliminada)                              |
| `nombre_personalizado`| `VARCHAR(120)` \| `NULL`    | Opcional                                                                              |
| `tipo_area`           | `ENUM('LEVANTE_CEBA','GESTACION','MATERNIDAD','REPRODUCCION','CHIQUERO')` | Requerido |
| `numeracion`          | `VARCHAR(40)` \| `NULL`     | Opcional (√∫til para c√≥digos: `LC-01`, `G-01`, etc.)                                  |
| `estado`              | `ENUM('ACTIVA','INACTIVA')` | Por defecto `'ACTIVA'`                                                                |
| `created_at`          | `DATETIME`                  | Seteado por `nowWithAudit()`                                                          |
| `created_by`          | `CHAR(36)` \| `NULL`        | UUID del actor                                                                        |
| `updated_at`          | `DATETIME` \| `NULL`        | √öltima actualizaci√≥n                                                                  |
| `updated_by`          | `CHAR(36)` \| `NULL`        | UUID del actor                                                                        |
| `deleted_at`          | `DATETIME` \| `NULL`        | Borrado l√≥gico                                                                        |
| `deleted_by`          | `CHAR(36)` \| `NULL`        | UUID del actor                                                                        |

> **√çndices sugeridos:**
> - `INDEX (aprisco_id)` para joins y filtros.  
> - `INDEX (tipo_area)` para filtros por cat√°logo.  
> - `UNIQUE (aprisco_id, tipo_area, numeracion)` **o** `UNIQUE (aprisco_id, tipo_area, nombre_personalizado)` seg√∫n la regla de negocio de unicidad.

---

## Reglas de Auditor√≠a y Zona Horaria

- `ClientEnvironmentInfo::applyAuditContext($db, $userId)` y `TimezoneManager::applyTimezone()` antes de insertar/actualizar/eliminar.  
- Fechas desde `getCurrentDatetime()` ajustadas a la TZ activa.  
- Fallback de `created_by/updated_by/deleted_by` cuando no hay sesi√≥n: se utiliza un UUID local.

---

## C√≥digos de Estado HTTP

- `200 OK` ‚Äî Operaci√≥n exitosa.  
- `400 Bad Request` ‚Äî Par√°metros inv√°lidos/faltantes.  
- `404 Not Found` ‚Äî Recurso no encontrado.  
- `409 Conflict` ‚Äî Violaci√≥n de FK o unicidad (duplicados).  
- `500 Internal Server Error` ‚Äî Error inesperado.

---

## Rutas Registradas

```php
$router->get('/areas',                    ['controlador' => AreaController::class, 'accion' => 'listar']);
$router->get('/areas/{area_id}',          ['controlador' => AreaController::class, 'accion' => 'mostrar']);
$router->post('/areas',                   ['controlador' => AreaController::class, 'accion' => 'crear']);
$router->post('/areas/{area_id}',         ['controlador' => AreaController::class, 'accion' => 'actualizar']);
$router->post('/areas/{area_id}/estado',  ['controlador' => AreaController::class, 'accion' => 'actualizarEstado']);
$router->delete('/areas/{area_id}',       ['controlador' => AreaController::class, 'accion' => 'eliminar']);
```

---

## Ejemplos R√°pidos

```bash
# Crear
curl -X POST 'https://tu-dominio/areas' -H 'Content-Type: application/json'   -d '{ "aprisco_id": "{uuid-aprisco}", "tipo_area": "LEVANTE_CEBA", "nombre_personalizado": "Corral 1", "numeracion": "LC-01" }'

# Listar por aprisco
curl -X GET 'https://tu-dominio/areas?aprisco_id={uuid-aprisco}'

# Actualizar (nombre y estado)
curl -X POST 'https://tu-dominio/areas/{uuid-area}' -H 'Content-Type: application/json'   -d '{ "nombre_personalizado": "Corral 2", "estado": "INACTIVA" }'

# Cambiar solo estado
curl -X POST 'https://tu-dominio/areas/{uuid-area}/estado' -H 'Content-Type: application/json'   -d '{ "estado": "ACTIVA" }'

# Eliminar (soft)
curl -X DELETE 'https://tu-dominio/areas/{uuid-area}'
```
